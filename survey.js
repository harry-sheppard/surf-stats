// Prepopulate with random data
localStorage.setItem('userData', JSON.stringify([
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Oct", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Oct", "height": "4 - 4.5", "surfable": "No" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Jun", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Jan", "height": "5 - 5.5", "surfable": "No" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Mar", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Jan", "height": "4 - 4.5", "surfable": "No" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "May", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "May", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Jun", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "May", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Jan", "height": "4 - 4.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Jun", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Jan", "height": "6 - 6.5", "surfable": "No" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Jun", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Aug", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Oct", "height": "3 - 3.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Mar", "height": "4 - 4.5", "surfable": "No" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Oct", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Jun", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Feb", "height": "5 - 5.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Mar", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Mar", "height": "4 - 4.5", "surfable": "No" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Oct", "height": "4 - 4.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Jun", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Apr", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Mar", "height": "3 - 3.5", "surfable": "No" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "May", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Aug", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Aug", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Jan", "height": "5 - 5.5", "surfable": "No" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Apr", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Oct", "height": "4 - 4.5", "surfable": "No" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Aug", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Jul", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Mar", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "May", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Jun", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Jul", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Feb", "height": "5 - 5.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Jan", "height": "5 - 5.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Jan", "height": "5 - 5.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Feb", "height": "4 - 4.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Nov", "height": "5 - 5.5", "surfable": "No" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Aug", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Apr", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Oct", "height": "4 - 4.5", "surfable": "No" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Jul", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Jul", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Jan", "height": "4 - 4.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Apr", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Dec", "height": "5 - 5.5", "surfable": "No" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Dec", "height": "5 - 5.5", "surfable": "No" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Jun", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Jan", "height": "5 - 5.5", "surfable": "No" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Mar", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Apr", "height": "3 - 3.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Nov", "height": "5 - 5.5", "surfable": "No" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Jan", "height": "5 - 5.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Oct", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Oct", "height": "4 - 4.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Aug", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Aug", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Oct", "height": "3 - 3.5", "surfable": "No" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Feb", "height": "3 - 3.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Dec", "height": "6 - 6.5", "surfable": "No" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Sep", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Aug", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "May", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Feb", "height": "4 - 4.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Sep", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Apr", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Jun", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Oct", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Mar", "height": "4 - 4.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Mar", "height": "3 - 3.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Feb", "height": "5 - 5.5", "surfable": "No" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Apr", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Jun", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Apr", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Nov", "height": "5 - 5.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Jul", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Jan", "height": "5 - 5.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "May", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Apr", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Feb", "height": "5 - 5.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Jul", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Oct", "height": "4 - 4.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Apr", "height": "3 - 3.5", "surfable": "No" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Mar", "height": "4 - 4.5", "surfable": "No" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Aug", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Jun", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Jan", "height": "4 - 4.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Jun", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Jul", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Sep", "height": "3 - 3.5", "surfable": "Yes" },
{ "loc": "Tramore, 52.1614° N, 7.1493° W", "month": "Oct", "height": "4 - 4.5", "surfable": "Yes" },
{ "loc": "Strandhill, 54.2700° N, 8.5989° W", "month": "Jun", "height": "0 - 0.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Oct", "height": "2 - 2.5", "surfable": "Yes" },
{ "loc": "Bundoran, 54.4791° N, 8.2779° W", "month": "Apr", "height": "1 - 1.5", "surfable": "Yes" },
{ "loc": "Lahinch, 52.9335° N, 9.3441° W", "month": "Jun", "height": "1 - 1.5", "surfable": "Yes" }
]));

// Load user data from localStorage (returns an array)
function loadData() {
  const storedData = localStorage.getItem('userData');
  return storedData ? JSON.parse(storedData) : [];
}

// Save user data array back to localStorage
function saveData(users) {
  localStorage.setItem('userData', JSON.stringify(users));
}

// Update the summary and submissions table on the page
function updateSummary() {
  const users = loadData();
  const summaryDiv = document.getElementById('summary');
  const submissionsDiv = document.getElementById('allSubmissions');

  let totalUsers = users.length;
  let totalHeight = 0;

  users.forEach(user => {
	totalHeight += Number(user.height);
  });

  let avgHeight = totalUsers ? (totalHeight / totalUsers).toFixed(1) : 0;

 let summaryHTML = `<p>Total Submissions: ${totalUsers}</p>
                     <canvas id="myChart" width="400" height="100"></canvas>`;
					 
  summaryDiv.innerHTML = summaryHTML;

  // Build a table to list all submissions
  let tableHTML = `<table>
					<thead>
					  <tr>
						<th>Location</th>
						<th>Month</th>													  
						<th>Height Range(m)</th>
						<th>Surfable</th>
					  </tr>
					</thead>
					<tbody>`;
  users.forEach(user => {
	tableHTML += `<tr>
					<td>${user.loc}</td>
					<td>${user.month}</td>
					<td>${user.height}</td>
					<td>${user.surfable}</td>					
				  </tr>`;
  });
  tableHTML += '</tbody></table>';
  submissionsDiv.innerHTML = tableHTML;
}

// Handle form submission: save the data and update the summary display
document.getElementById('userForm').addEventListener('submit', function(event) {
  event.preventDefault();
  slider = document.getElementById('height_slider');
  const height = (slider.value != 6) ? slider.value + " - " + (slider.value*1+0.5) : '6 + ';
  const month = document.getElementById('month').value;
  const isSurfable = document.getElementById('surfable').checked;
  
  let surfable;
  surfable = (isSurfable) ? "Yes" : "No"
  
  loc_dropdown_value = document.getElementById('location_name_dropdown').value;
  let loc;
  if (loc_dropdown_value === "other") {
	const location_name = document.getElementById('location_name_input').value;
	
	if (!allLetter(location_name)) {
		alert("Please Enter a Valid Placename");
		return
	}
	
	const latitude = document.getElementById('lat_input').value;
	const longitude = document.getElementById('long_input').value;
	
	if (latitude >90 || latitude <=-90 || longitude > 180 || longitude <= -180) {
		alert('Please fill in a valid location');
		console.log(latitude, longitude)
		return;
	}
	
	loc = capitalizeFirstLetter(location_name) + ", " + latitude.toString() + "° N, " + longitude.toString() + "° W";
	  
  } else {
	loc = loc_dropdown_value;
  }

  if (!loc || !month || !height || !surfable) {
	console.log(month, loc, height)
	alert('Please fill in all fields.');
	return;
  }

  const users = loadData();
  users.push({loc, month, height, surfable});
  saveData(users);
  updateSummary();
  drawGroupedChart();

  // Reset the form after submission
  document.getElementById('userForm').reset();
  document.getElementById('specify_location').style.display = "none"
  document.getElementById('height_slider').value = 0;
  heightValue.textContent = (slider.value != 6) ? slider.value + " - " + (slider.value*1+0.5) : '6 + ';
});

// Initialize the summary when the page loads
document.addEventListener('DOMContentLoaded', function () {
	updateSummary();
	drawGroupedChart();
	});

function capitalizeFirstLetter(val) {
	return String(val).charAt(0).toUpperCase() + String(val).slice(1);
}

  function clearData() {
// Remove the data stored under 'userData' in localStorage
localStorage.removeItem('userData');
// Update the table and summary display to reflect the change
updateSummary();
document.getElementById("specify_location").style.display = "none";
document.getElementById("myChart").style.display = "none";
}

document.getElementById('location_name_dropdown').addEventListener('change', function(event) {
	loc_name = document.getElementById('location_name_dropdown').value
	console.log(loc_name)
	if (loc_name === "other") {
		document.getElementById("specify_location").style.display = "block";
	} else {
		document.getElementById("specify_location").style.display = "none";
	}
})

slider = document.getElementById('height_slider');
slider.addEventListener('input', function() {
  heightValue.textContent = (slider.value != 6) ? slider.value + " - " + (slider.value*1+0.5) : '6 + ';
});

function allLetter(input) {
   var letters = /^[A-Za-z\s]+$/;
   return letters.test(input)
}

function drawGroupedChart() {
  const users = loadData();
  const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

  // Get unique combinations of location and surfable (as "loc|surfable")
  const combinations = new Set();
  users.forEach(user => {
    combinations.add(`${user.loc}|${user.surfable}`);
  });
  const comboArray = Array.from(combinations);

  // Function to parse a height string into a number
  function parseHeight(heightStr) {
    let heightNum = 0;
    if (heightStr.includes('+')) {
      heightNum = parseFloat(heightStr);
    } else if (heightStr.includes(' - ')) {
      const parts = heightStr.split(' - ');
      if (parts.length === 2) {
        const lower = parseFloat(parts[0]);
        const upper = parseFloat(parts[1]);
        heightNum = (lower + upper) / 2;
      }
    } else {
      heightNum = parseFloat(heightStr);
    }
    return heightNum;
  }

  // Create a mapping for each unique location to a hardcoded background color
  const uniqueLocations = Array.from(new Set(users.map(user => user.loc)));
  const colorList = [
    'rgba(30, 90, 192, 0.5)',  
    'rgba(75, 140, 192, 0.5)',  
    'rgba(70, 150, 210, 0.5)',   
    'rgba(10, 192, 192, 0.5)',  
    'rgba(153, 102, 255, 0.5)', 
    'rgba(255, 159, 64, 0.5)'   
  ];
  const locationColorMap = {};
  uniqueLocations.forEach((loc, index) => {
    locationColorMap[loc] = colorList[index % colorList.length];
  });

  // Build datasets for each (location, surfable) combination.
  const datasets = comboArray.map(combo => {
    const [loc, surfable] = combo.split('|');
    // For each month, calculate the average height for submissions matching this combination.
    const data = months.map(month => {
      const filtered = users.filter(user =>
        user.loc === loc && user.surfable === surfable && user.month === month
      );
      if (filtered.length === 0) return 0;
      const sum = filtered.reduce((acc, user) => acc + parseHeight(user.height), 0);
      return sum / filtered.length;
    });

    // Use the mapped background color for the location.
    const backgroundColor = locationColorMap[loc];
    // Set the border color based on surfability: blue for "Yes", red for "No"
    const borderColor = (surfable === "Yes") ? 'rgba(54, 235, 162, 1)' : 'rgba(255, 99, 132, 1)';

    return {
      label: `${loc} (${surfable})`,
      data: data,
      backgroundColor: backgroundColor,
      borderColor: borderColor,
      borderWidth: 2
    };
  });

  // Get the canvas context for the chart
  const ctx = document.getElementById('myChart').getContext('2d');

  // If a chart instance already exists, destroy it before creating a new one.
  if (window.myChart && typeof window.myChart.destroy === 'function') {
    window.myChart.destroy();
  }
  

  // Create the grouped bar chart
  window.myChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: months,
      datasets: datasets
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Height (m)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Month'
          }
        }
      },
      plugins: {
        legend: {
          labels: {
            // Override the default generateLabels function.
            generateLabels: function(chart) {
              // Get the default legend items generated by Chart.js.
              const defaultLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
              // Create a map to hold unique location names.
              const uniqueMap = {};
              defaultLabels.forEach(item => {
                // Assume the dataset label is in the form "Location (Yes)" or "Location (No)".
                let locName = item.text.split('(')[0].trim();
                if (!uniqueMap[locName]) {
                  uniqueMap[locName] = {
                    text: locName.split(',')[0],
                    fillStyle: item.fillStyle,
					strokeStyle: item.fillStyle,
                    hidden: false
                  };
                }
              });
              // Convert the map to an array.
              let uniqueItems = Object.values(uniqueMap);
              // Append custom legend item to represent surfable.
              uniqueItems.push({
                text: 'Surfable',
                fillStyle: 'rgba(255, 255, 255, 0.5)',
				strokeStyle: 'rgba(54, 235, 162, 1)',
                hidden: false
              }, {
				text: 'Not Surfable',
                fillStyle: 'rgba(255, 255, 255, 0.5)',
				strokeStyle: 'rgba(255, 99, 132, 1)',
				strokeWidth: 2,
                hidden: false 				  
			  }
			  
			  );
              return uniqueItems;
            }
          }
        },
        title: {
          display: true,
          text: 'Average Height per Month by Location'
        }
      }
    }
  });
}